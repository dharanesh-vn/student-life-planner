<div class="container">
  <div *ngIf="isLoading" class="loading-overlay"><div class="spinner"></div></div>
  <div *ngIf="successMessage" class="success-message">{{ successMessage }}</div>
  <div *ngIf="errorMessage" class="error-message">{{ errorMessage }}</div>

  <h2>Finance Dashboard</h2>

  <div class="overview-grid">
    <div class="card overview-card">
      <h3>Total Balance</h3>
      <p class="amount" [ngClass]="{'negative': totalBalance < 0}">{{ totalBalance | currency }}</p>
    </div>
    <div class="card overview-card">
      <h3>Monthly Subscriptions</h3>
      <p class="amount expense">{{ totalMonthlySubscriptions | currency }} / month</p>
    </div>
  </div>

  <div class="finance-grid">
    <div class="left-column">
      <div class="card">
        <h3>My Accounts</h3>
        <ul class="account-list" *ngIf="accounts.length > 0">
          <li *ngFor="let account of accounts">
            <span class="account-name">{{ account.accountName }}</span>
            <span class="account-balance" [ngClass]="{'negative': account.balance < 0}">{{ account.balance | currency }}</span>
            <button class="delete-btn small" (click)="onDeleteAccount(account._id)" title="Delete Account">×</button>
          </li>
        </ul>
        <form [formGroup]="accountForm" (ngSubmit)="onAddAccount()" class="inline-form">
          <div class="form-field">
            <input type="text" formControlName="accountName" placeholder="New Account Name">
            <div *ngIf="af['accountName'].invalid && af['accountName'].touched" class="field-error small">
              <small *ngIf="af['accountName'].errors?.['required']">Name is required.</small>
              <small *ngIf="af['accountName'].errors?.['pattern']">Name must be alphanumeric.</small>
            </div>
          </div>
          <div class="form-field">
            <input type="number" step="0.01" formControlName="balance" placeholder="Balance">
            <div *ngIf="af['balance'].invalid && af['balance'].touched" class="field-error small">
              <small>Must be a valid number.</small>
            </div>
          </div>
          <button type="submit" class="primary" [disabled]="accountForm.invalid">+</button>
        </form>
      </div>

      <div class="card">
        <h3>Subscriptions</h3>
        <ul class="sub-list" *ngIf="subscriptions.length > 0">
          <li *ngFor="let sub of subscriptions">
            <span>{{ sub.name }}</span>
            <span class="sub-cost">{{ sub.monthlyCost | currency }}</span>
            <button class="delete-btn small" (click)="onDeleteSubscription(sub._id)" title="Delete Subscription">×</button>
          </li>
        </ul>
        <form [formGroup]="subscriptionForm" (ngSubmit)="onAddSubscription()" class="inline-form">
          <div class="form-field">
            <input type="text" formControlName="name" placeholder="Subscription Name">
            <div *ngIf="sf['name'].invalid && sf['name'].touched" class="field-error small"><small>Name is required.</small></div>
          </div>
          <div class="form-field">
            <input type="number" step="0.01" formControlName="monthlyCost" placeholder="Cost/mo">
            <div *ngIf="sf['monthlyCost'].invalid && sf['monthlyCost'].touched" class="field-error small"><small>Cost must be > 0.</small></div>
          </div>
          <button type="submit" class="primary" [disabled]="subscriptionForm.invalid">+</button>
        </form>
      </div>
    </div>

    <div class="right-column">
      <div class="card">
        <h3>Log Transaction</h3>
        <form [formGroup]="transactionForm" (ngSubmit)="onAddTransaction()">
          <div class="form-group">
            <label>Description</label>
            <input type="text" formControlName="description">
            <div *ngIf="tf['description'].invalid && tf['description'].touched" class="field-error"><small>Description is required.</small></div>
          </div>
          <div class="form-grid-3">
            <div class="form-group">
              <label>Amount</label>
              <input type="number" step="0.01" formControlName="amount">
              <div *ngIf="tf['amount'].invalid && tf['amount'].touched" class="field-error"><small>Amount must be > 0.</small></div>
            </div>
            <div class="form-group">
              <label>Type</label>
              <select formControlName="type">
                <option>Expense</option>
                <option>Income</option>
              </select>
            </div>
            <div class="form-group">
              <label>Account</label>
              <select formControlName="account">
                <option value="" disabled>Select Account</option>
                <option *ngFor="let account of accounts" [value]="account._id">{{ account.accountName }}</option>
              </select>
              <div *ngIf="tf['account'].invalid && tf['account'].touched" class="field-error"><small>Please select an account.</small></div>
            </div>
          </div>
          <button type="submit" class="primary" [disabled]="transactionForm.invalid">Log Transaction</button>
        </form>
      </div>
      
      <div class="card">
        <h3>Recent Transactions</h3>
        <div *ngIf="transactions.length === 0 && !isLoading" class="empty-state">No transactions logged yet.</div>
        <ul class="transaction-list" *ngIf="transactions.length > 0">
          <li *ngFor="let trans of transactions">
            <div class="trans-details">
              <strong>{{ trans.description }}</strong>
              <span *ngIf="trans.account && typeof trans.account === 'object'">{{ trans.account.accountName }} - {{ trans.date | date:'mediumDate' }}</span>
            </div>
            <div class="trans-amount" [class.income]="trans.type === 'Income'" [class.expense]="trans.type === 'Expense'">
              {{ (trans.type === 'Income' ? '+' : '−') + (trans.amount | currency) }}
              <button class="delete-btn small" (click)="onDeleteTransaction(trans._id)" title="Delete Transaction">×</button>
            </div>
          </li>
        </ul>
      </div>
    </div>
  </div>
</div>